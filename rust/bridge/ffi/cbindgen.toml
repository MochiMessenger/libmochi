#
# Copyright (C) 2020-2021 Mochi Messenger, LLC.
# SPDX-License-Identifier: AGPL-3.0-only
#

language = "C"

header = "/*\nCopyright (C) 2020-2021 Mochi Messenger, LLC.\nSPDX-License-Identifier: AGPL-3.0-only\n*/\n"

include_guard = "MOCHI_FFI_H_"

autogen_warning = "/* This file was automatically generated by cbindgen */"

style = "type"

usize_is_size_t = true

[defines]
"feature = mochi-media" = "MOCHI_MEDIA_SUPPORTED"

[enum]
prefix_with_name = true

[export]
include = [
    "MochiErrorCode",
    "FfiDirection",
    "FfiCiphertextMessageType",
    "FfiContentHint",
    "RandomnessBytes",
]
exclude = ["TAG_SIZE", "NONCE_SIZE"]
item_types = [
    "enums",
    "functions",
    "opaque",
    "structs",
    "typedefs",
    "constants",
]
# FIXME: this doesn't work well with constants in SCREAMING_SNAKE_CASE
prefix = "Mochi"
renaming_overrides_prefixing = true

[export.rename]
"FfiSessionStoreStruct" = "MochiSessionStore"
"FfiIdentityKeyStoreStruct" = "MochiIdentityKeyStore"
"FfiPreKeyStoreStruct" = "MochiPreKeyStore"
"FfiSignedPreKeyStoreStruct" = "MochiSignedPreKeyStore"
"FfiKyberPreKeyStoreStruct" = "MochiKyberPreKeyStore"
"FfiSenderKeyStoreStruct" = "MochiSenderKeyStore"
"FfiDirection" = "MochiDirection"
"FfiCiphertextMessageType" = "MochiCiphertextMessageType"
"FfiContentHint" = "MochiContentHint"
"FfiInputStreamStruct" = "MochiInputStream"
"FfiSyncInputStreamStruct" = "MochiSyncInputStream"
"FfiLookupResponseEntry" = "MochiLookupResponseEntry"

"BorrowedSliceOfc_uchar" = "MochiBorrowedBuffer"
"BorrowedSliceOfBorrowedSliceOfc_uchar" = "MochiBorrowedSliceOfBuffers"
"BorrowedMutableSliceOfc_uchar" = "MochiBorrowedMutableBuffer"
"OwnedBufferOfc_uchar" = "MochiOwnedBuffer"
"OwnedBufferOfFfiLookupResponseEntry" = "MochiOwnedLookupResponseEntryList"
"FfiOptionalServiceIdFixedWidthBinaryBytes" = "MochiOptionalServiceIdFixedWidthBinaryBytes"
"CPromisec_void" = "MochiCPromiseRawPointer"

"RawCancellationId" = "MochiCancellationId"

# Avoid double-prefixing these
"MochiFfiError" = "MochiFfiError"
"MochiErrorCode" = "MochiErrorCode"
"MochiMessage" = "MochiMessage"

[export.mangle]
remove_underscores = true

[fn]
sort_by = "None"
args = "horizontal"

[parse]
parse_deps = true
include = [
    "libmochi-core",
    "libmochi-protocol",
    "libmochi-bridge-types",
    "mochi-crypto",
    "mochi-pin",
    "zkgroup",
    "mochi-media",
    "mediasan-common",
    "mp4san",
    "webpsan",
]
extra_bindings = ["libmochi-bridge", "libmochi-bridge-types", "zkgroup"]

[parse.expand]
crates = ["libmochi-ffi", "libmochi-bridge"]
features = [
    "libmochi-bridge/ffi",
    "libmochi-bridge/mochi-media",
    "libmochi-bridge/testing-fns",
]
